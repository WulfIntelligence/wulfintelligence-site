<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Productivity Tamagotchi</title>
  <!-- Let the OS choose by default; we also support manual overrides -->
  <meta name="color-scheme" content="light dark" />
  <style>
    /* Default (dark) */
    :root{
      --bg: #0f1220;
      --panel:#161a2f;
      --panel-2:#1f2442;
      --text:#e8ecff;
      --muted:#b9c0ffcc;
      --accent:#6aa3ff;
      --accent-2:#7effb8;
      --danger:#ff6b6b;
      --good:#7aff92;
      --warn:#ffd86a;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --radius: 14px;
    }
    /* Auto mode: follow OS to light */
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f5f7ff; --panel:#ffffff; --panel-2:#eef2ff;
        --text:#0c1133; --muted:#3c4786; --accent:#274bdb; --accent-2:#1ea672;
        --danger:#d90429; --good:#0b8c2f; --warn:#b8860b; --shadow:0 12px 24px rgba(0,0,0,.08);
      }
    }
    /* Manual override: dark */
    [data-theme="dark"]{
      --bg: #0f1220; --panel:#161a2f; --panel-2:#1f2442; --text:#e8ecff;
      --muted:#b9c0ffcc; --accent:#6aa3ff; --accent-2:#7effb8;
      --danger:#ff6b6b; --good:#7aff92; --warn:#ffd86a; --shadow: 0 8px 24px rgba(0,0,0,.35);
    }
    /* Manual override: light */
    [data-theme="light"]{
      --bg:#f5f7ff; --panel:#ffffff; --panel-2:#eef2ff;
      --text:#0c1133; --muted:#3c4786; --accent:#274bdb; --accent-2:#1ea672;
      --danger:#d90429; --good:#0b8c2f; --warn:#b8860b; --shadow:0 12px 24px rgba(0,0,0,.08);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial,Noto Sans;
      background:radial-gradient(1200px 600px at 80% -10%, #2b3160 0%, transparent 50%) , radial-gradient(1000px 500px at -10% 110%, #22305c 0%, transparent 55%), var(--bg);
      color:var(--text);
      display:grid;
      grid-template-rows:auto 1fr auto;
      min-height:100%;
    }
    header{
      padding:16px clamp(12px,3vw,24px);
      display:flex; align-items:center; gap:16px; justify-content:space-between;
    }
    header .title{font-weight:700; letter-spacing:.2px}
    header .title small{display:block; font-weight:500; opacity:.8}
    header .actions{display:flex; gap:8px; flex-wrap:wrap}
    button, input[type="submit"]{
      appearance:none; border:0; background:var(--accent);
      color:white; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer;
      box-shadow:var(--shadow); transition:transform .04s ease;
    }
    button.secondary{background:var(--panel-2); color:var(--text)}
    button.ghost{background:transparent; border:2px solid var(--panel-2)}
    button:active{transform:translateY(1px)}
    main{
      padding:0 clamp(12px,3vw,24px) 24px;
      display:grid; gap:16px;
      grid-template-columns: 1.1fr .9fr; grid-template-areas:
      "pet timer"
      "tasks tasks"
      "achv achv";
    }
    @media (max-width: 900px){
      main{grid-template-columns:1fr; grid-template-areas:
      "pet" "timer" "tasks" "achv";}
    }
    .panel{
      background:linear-gradient(180deg, var(--panel), var(--panel-2));
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:16px;
    }

    /* PET */
    #petPanel{grid-area:pet; display:grid; grid-template-rows:auto auto 1fr; gap:10px}
    .petRow{display:flex; gap:12px; align-items:center; justify-content:space-between}
    .petName input{
      background:transparent; border:2px solid var(--panel-2);
      border-radius:10px; padding:8px 10px; color:var(--text);
      min-width:180px; font-weight:700;
    }
    .stats{display:grid; grid-template-columns:repeat(4,1fr); gap:8px; width:100%}
    .stat{
      background:rgba(255,255,255,.05); border-radius:10px; padding:10px;
    }
    .stat label{display:block; font-size:12px; opacity:.8}
    .meter{height:10px; border-radius:8px; background:#00000020; margin-top:6px; overflow:hidden}
    .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent-2))}
    .petStage{
      border-radius:12px; padding:10px; display:flex; align-items:center; justify-content:center;
      min-height:220px; background:rgba(0,0,0,.06);
    }
    svg.pet{width:min(360px,100%); height:auto}
    .pet .face-happy{display:var(--disp-happy, block)}
    .pet .face-neutral{display:var(--disp-neutral, none)}
    .pet .face-sad{display:var(--disp-sad, none)}
    .pet.shake{animation:shake .45s linear 1}
    @keyframes shake{25%{transform:translateX(-4px)} 50%{transform:translateX(4px)} 75%{transform:translateX(-2px)}}

    /* TIMER */
    #timerPanel{grid-area:timer; display:grid; gap:12px}
    .timerTop{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .timerDisplay{
      font-size:42px; font-weight:800; background:rgba(255,255,255,.06);
      padding:12px 14px; border-radius:12px; letter-spacing:.5px; text-align:center;
    }
    .timerControls{display:flex; gap:8px; flex-wrap:wrap}
    .timerSettings{
      display:grid; grid-template-columns:repeat(3,1fr); gap:8px;
    }
    .timerSettings .field{
      background:rgba(255,255,255,.05); padding:10px; border-radius:10px;
    }
    .timerSettings input{
      width:100%; padding:8px; border-radius:8px; border:2px solid var(--panel-2);
      background:transparent; color:var(--text); font-weight:700; text-align:center;
    }

    /* TASKS */
    #tasksPanel{grid-area:tasks; display:grid; gap:12px}
    .taskInput{display:flex; gap:8px}
    .taskInput input[type=text]{
      flex:1; padding:12px; border-radius:10px; border:2px solid var(--panel-2);
      background:transparent; color:var(--text); font-weight:600;
    }
    .taskList{display:grid; gap:8px}
    .task{
      display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center;
      background:rgba(255,255,255,.05); padding:10px; border-radius:12px;
    }
    .task.done{opacity:.6; text-decoration:line-through}
    .task button{padding:6px 10px; border-radius:8px}
    .empty{opacity:.7; font-style:italic; padding:8px}

    /* ACHIEVEMENTS */
    #achvPanel{grid-area:achv; display:grid; gap:10px}
    .achvGrid{display:grid; gap:8px; grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
    .badge{
      border-radius:12px; background:rgba(255,255,255,.05); padding:12px;
    }
    .badge.earned{outline:2px solid var(--accent-2); box-shadow:0 0 0 3px #0000, var(--shadow)}
    .badge small{display:block; opacity:.75}
    .streak{font-weight:800}

    footer{
      padding:12px clamp(12px,3vw,24px); opacity:.8; display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between;
    }
    footer .left, footer .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .danger{background:var(--danger)!important}
    .warn{background:var(--warn)!important; color:#222}
    .muted{opacity:.8}
    .hidden{display:none!important}
    @media (prefers-reduced-motion: reduce){
      .pet.shake{animation:none}
    }
  </style>
</head>
<body>
  <header>
    <div class="title">
      Productivity Tamagotchi
      <small>Finish tasks, feed your buddy, keep the streak alive.</small>
    </div>
    <div class="actions">
      <button id="exportBtn" class="secondary" title="Download a backup JSON">Export</button>
      <input id="importFile" type="file" accept="application/json" class="hidden" />
      <button id="importBtn" class="secondary" title="Restore from a backup JSON">Import</button>
      <button id="themeBtn" class="ghost" title="Toggle light/dark">Theme</button>
    </div>
  </header>

  <main>
    <section id="petPanel" class="panel" aria-label="Pet">
      <div class="petRow">
        <div class="petName">
          <label for="petName"><strong>Pet name</strong></label>
          <input id="petName" maxlength="24" placeholder="Name your buddy…" />
        </div>
        <div class="stats" role="group" aria-label="Pet stats">
          <div class="stat" title="Fullness (0–100)">
            <label>Fullness</label>
            <div class="meter"><div id="barHunger" class="bar"></div></div>
          </div>
          <div class="stat" title="Energy (0–100)">
            <label>Energy</label>
            <div class="meter"><div id="barEnergy" class="bar"></div></div>
          </div>
          <div class="stat" title="Mood (0–100)">
            <label>Mood</label>
            <div class="meter"><div id="barMood" class="bar"></div></div>
          </div>
          <div class="stat" title="Cleanliness (0–100)">
            <label>Clean</label>
            <div class="meter"><div id="barClean" class="bar"></div></div>
          </div>
        </div>
      </div>

      <div class="petStage" aria-live="polite">
        <svg class="pet" viewBox="0 0 240 200" role="img" aria-label="Your pet">
          <defs>
            <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#6aa3ff"/>
              <stop offset="100%" stop-color="#7effb8"/>
            </linearGradient>
          </defs>
          <ellipse cx="120" cy="110" rx="80" ry="70" fill="url(#g1)" opacity="0.95"></ellipse>
          <ellipse cx="120" cy="125" rx="55" ry="45" fill="#ffffff33"></ellipse>
          <ellipse cx="70" cy="50" rx="18" ry="26" fill="url(#g1)" />
          <ellipse cx="170" cy="50" rx="18" ry="26" fill="url(#g1)" />
          <g class="face-happy">
            <circle cx="95" cy="95" r="7" fill="#1b1b1b"/>
            <circle cx="145" cy="95" r="7" fill="#1b1b1b"/>
            <path d="M95 130 Q120 150 145 130" fill="none" stroke="#1b1b1b" stroke-width="6" stroke-linecap="round"/>
          </g>
          <g class="face-neutral">
            <circle cx="95" cy="95" r="6" fill="#1b1b1b"/>
            <circle cx="145" cy="95" r="6" fill="#1b1b1b"/>
            <line x1="100" y1="132" x2="140" y2="132" stroke="#1b1b1b" stroke-width="5" stroke-linecap="round"/>
          </g>
          <g class="face-sad">
            <circle cx="95" cy="95" r="6" fill="#1b1b1b"/>
            <circle cx="145" cy="95" r="6" fill="#1b1b1b"/>
            <path d="M100 140 Q120 120 140 140" fill="none" stroke="#1b1b1b" stroke-width="5" stroke-linecap="round"/>
          </g>
        </svg>
      </div>

      <div class="petRow">
        <div>
          <button id="feedBtn">Feed 🍎</button>
          <button id="restBtn" class="secondary">Rest 😴</button>
          <button id="washBtn" class="secondary">Wash 🫧</button>
        </div>
        <div class="muted" id="petTip" aria-live="polite"></div>
      </div>
    </section>

    <section id="timerPanel" class="panel" aria-label="Timer">
      <div class="timerTop">
        <div class="timerDisplay" id="timerDisplay" aria-live="polite">25:00</div>
        <div class="timerControls">
          <button id="startBtn">Start</button>
          <button id="pauseBtn" class="secondary">Pause</button>
          <button id="resetBtn" class="secondary">Reset</button>
          <button id="completeBtn" class="warn" title="Finish & feed pet">Complete ✅</button>
        </div>
      </div>
      <div class="timerSettings">
        <div class="field">
          <label for="focusMins"><strong>Focus (min)</strong></label>
          <input id="focusMins" type="number" min="5" max="180" value="25" />
        </div>
        <div class="field">
          <label for="breakMins"><strong>Break (min)</strong></label>
          <input id="breakMins" type="number" min="1" max="60" value="5" />
        </div>
        <div class="field">
          <label for="autoCycle"><strong>Auto cycle</strong></label>
          <button id="autoCycle" class="secondary" aria-pressed="false">Off</button>
        </div>
      </div>
      <div class="muted">Tip: Completing a focus session feeds your pet and boosts mood. Pausing too often reduces energy.</div>
    </section>

    <section id="tasksPanel" class="panel" aria-label="Tasks">
      <form id="taskForm" class="taskInput" autocomplete="off">
        <input id="taskText" type="text" placeholder="Add a task and press Enter…" />
        <button type="submit">Add</button>
      </form>
      <div id="taskList" class="taskList" role="list"></div>
      <div class="muted">
        <span class="streak">🔥 Streak: <span id="streakDays">0</span> day(s)</span> •
        Completed today: <span id="completedToday">0</span>
      </div>
    </section>

    <section id="achvPanel" class="panel" aria-label="Achievements">
      <div><strong>Achievements</strong></div>
      <div class="achvGrid" id="achvGrid"></div>
    </section>
  </main>

  <footer>
    <div class="left">
      <button id="resetData" class="danger">Factory Reset</button>
      <span class="muted">Data is saved locally in your browser.</span>
    </div>
    <div class="right muted">
      v1.0.1 • Single-file MVP
    </div>
  </footer>

  <script>
  ;(() => {
    "use strict";

    /** -------------------------------
     * Utils & Persistence
     * ------------------------------- */
    const STORE_KEY = "prod-tamago-v1";
    const now = () => new Date().toISOString();
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const dateKey = d => d.toISOString().slice(0,10); // YYYY-MM-DD

    // UUID fallback for older browsers
    const uid = () => (crypto && crypto.randomUUID)
      ? crypto.randomUUID()
      : ("id-" + Math.random().toString(36).slice(2) + Date.now().toString(36));

    const defaultState = () => ({
      version: 1,
      theme: "auto",         // "auto" | "light" | "dark"
      petName: "Buddy",
      pet: {
        hunger: 70,          // fullness 0..100
        energy: 70,          // 0..100
        mood:   70,          // 0..100
        clean:  80,          // 0..100
        lastTick: now(),
      },
      timer: {
        mode: "focus",       // "focus" | "break"
        remainingSec: 25*60,
        running: false,
        focusMins: 25,
        breakMins: 5,
        autoCycle: false,
        lastStatusChange: now(),
        pausesToday: 0
      },
      tasks: [],             // {id, text, done, createdAt, doneAt?}
      achievements: {},      // id -> timestamp
      stats: {
        completedToday: 0,
        lastCompletionDate: null,  // FIX: null until the first completion
        streakDays: 0
      },
      lastSave: now()
    });

    function loadState(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        if(!raw) return defaultState();
        const s = JSON.parse(raw);
        return migrateState(s);
      }catch(e){
        console.warn("State load error; resetting:", e);
        return defaultState();
      }
    }

    function migrateState(s){
      s.version ??= 1;
      // If old schema had today's date as default, normalize to null
      if(s.stats && s.stats.lastCompletionDate === dateKey(new Date()) && (s.stats.streakDays ?? 0) === 0){
        s.stats.lastCompletionDate = null;
      }
      return s;
    }

    let state = loadState();
    const saveState = () => {
      try{
        state.lastSave = now();
        localStorage.setItem(STORE_KEY, JSON.stringify(state));
      }catch(e){ console.error("Save failed:", e); }
    };

    /** -------------------------------
     * DOM
     * ------------------------------- */
    const $ = sel => document.querySelector(sel);
    const els = {
      petName: $('#petName'),
      bars: {
        hunger: $('#barHunger'),
        energy: $('#barEnergy'),
        mood:   $('#barMood'),
        clean:  $('#barClean'),
      },
      petSvg: document.querySelector('svg.pet'),
      petTip: $('#petTip'),

      timerDisplay: $('#timerDisplay'),
      startBtn: $('#startBtn'),
      pauseBtn: $('#pauseBtn'),
      resetBtn: $('#resetBtn'),
      completeBtn: $('#completeBtn'),
      focusMins: $('#focusMins'),
      breakMins: $('#breakMins'),
      autoCycle: $('#autoCycle'),

      taskForm: $('#taskForm'),
      taskText: $('#taskText'),
      taskList: $('#taskList'),
      completedToday: $('#completedToday'),
      streakDays: $('#streakDays'),

      achvGrid: $('#achvGrid'),

      exportBtn: $('#exportBtn'),
      importBtn: $('#importBtn'),
      importFile: $('#importFile'),
      resetData: $('#resetData'),
      themeBtn: $('#themeBtn'),
    };

    /** -------------------------------
     * Rendering
     * ------------------------------- */
    function setPetFace(){
      const {mood, energy, hunger} = state.pet;
      let face = "happy";
      if(mood < 40 || energy < 35 || hunger < 35) face = "neutral";
      if(mood < 25 || energy < 25 || hunger < 25) face = "sad";
      const root = els.petSvg;
      root.style.setProperty("--disp-happy", face==="happy" ? "block" : "none");
      root.style.setProperty("--disp-neutral", face==="neutral" ? "block" : "none");
      root.style.setProperty("--disp-sad", face==="sad" ? "block" : "none");
    }

    function updateBars(){
      const p = state.pet;
      els.bars.hunger.style.width = clamp(p.hunger,0,100) + "%";
      els.bars.energy.style.width = clamp(p.energy,0,100) + "%";
      els.bars.mood.style.width   = clamp(p.mood,0,100) + "%";
      els.bars.clean.style.width  = clamp(p.clean,0,100) + "%";
    }

    const formatTime = sec => {
      sec = Math.max(0, Math.floor(sec));
      const m = Math.floor(sec/60).toString().padStart(2,'0');
      const s = (sec%60).toString().padStart(2,'0');
      return `${m}:${s}`;
    };

    function renderTimer(){
      const t = state.timer;
      els.timerDisplay.textContent = formatTime(t.remainingSec);
      els.focusMins.value = t.focusMins;
      els.breakMins.value = t.breakMins;
      els.autoCycle.setAttribute("aria-pressed", String(t.autoCycle));
      els.autoCycle.textContent = t.autoCycle ? "On" : "Off";
    }

    function renderTasks(){
      const root = els.taskList;
      root.innerHTML = "";
      if(state.tasks.length === 0){
        const d = document.createElement('div');
        d.className = "empty";
        d.textContent = "No tasks yet. Add one above.";
        root.appendChild(d);
      } else {
        for(const task of state.tasks){
          const row = document.createElement('div');
          row.className = "task" + (task.done ? " done" : "");
          row.setAttribute('role','listitem');

          const checkbox = document.createElement('input');
          checkbox.type = "checkbox"; checkbox.checked = !!task.done;
          checkbox.addEventListener('change', () => toggleTask(task.id, checkbox.checked));

          const text = document.createElement('div');
          text.textContent = task.text;

          const right = document.createElement('div');
          const delBtn = document.createElement('button');
          delBtn.className="secondary";
          delBtn.textContent = "Delete";
          delBtn.addEventListener('click', () => deleteTask(task.id));

          right.appendChild(delBtn);
          row.appendChild(checkbox);
          row.appendChild(text);
          row.appendChild(right);
          root.appendChild(row);
        }
      }
      els.completedToday.textContent = state.stats.completedToday;
      els.streakDays.textContent = state.stats.streakDays;
    }

    const BADGES = [
      {id:"first_blood", name:"First Focus", desc:"Complete your first focus session."},
      {id:"five_in_day", name:"5 Today", desc:"Complete 5 tasks in a single day."},
      {id:"streak_3", name:"Streak 3", desc:"Maintain a 3-day streak."},
      {id:"streak_7", name:"Streak 7", desc:"Maintain a 7-day streak."},
      {id:"clean_freak", name:"Sparkly", desc:"Keep cleanliness ≥ 90 for a day."},
      {id:"well_fed", name:"Well-Fed", desc:"Keep fullness ≥ 90 for a day."},
    ];

    function renderAchievements(){
      els.achvGrid.innerHTML = "";
      for(const b of BADGES){
        const earned = !!state.achievements[b.id];
        const tile = document.createElement('div');
        tile.className = "badge" + (earned ? " earned" : "");
        tile.innerHTML = `<strong>${b.name}</strong><small>${b.desc}</small>${earned?`<small>✓ Earned</small>`:""}`;
        els.achvGrid.appendChild(tile);
      }
    }

    function renderAll(){
      els.petName.value = state.petName;
      setPetFace();
      updateBars();
      renderTimer();
      renderTasks();
      renderAchievements();
      applyTheme();
    }

    /** -------------------------------
     * Timer
     * ------------------------------- */
    let tickHandle = null;

    function clearTick(){
      if(tickHandle){ clearInterval(tickHandle); tickHandle = null; }
    }

    function startTimer(){
      const t = state.timer;
      if(t.running) return;
      t.running = true;
      t.lastStatusChange = now();
      tickHandle = setInterval(tick, 1000);
      saveState(); renderTimer();
    }

    function pauseTimer(){
      const t = state.timer;
      if(!t.running) return;
      t.running = false;
      t.pausesToday++;
      clearTick();
      saveState(); renderTimer();
      nudgeEnergy(-2); nudgeMood(-1);
      petShake(); setTip("Paused. Tiny energy drain.");
    }

    function resetTimer(){
      const t = state.timer;
      t.mode = "focus";
      t.remainingSec = t.focusMins * 60;
      t.running = false;
      t.pausesToday = 0;
      clearTick();
      saveState(); renderTimer();
      setTip("Timer reset. Ready to focus.");
    }

    function completeSession(){
      const t = state.timer;
      const wasFocus = t.mode === "focus";

      if(wasFocus){
        // awards + switches to break internally
        awardFocusComplete();
      } else {
        // finishing a break simply returns to focus
        switchTo("focus");
      }

      // Respect Auto cycle
      if(t.autoCycle){
        // keep running; interval already active if we came from tick
        t.running = true;
      } else {
        // stop at boundary
        t.running = false;
        clearTick();
      }

      saveState(); renderTimer();
    }

    function switchTo(mode){
      const t = state.timer;
      t.mode = mode;
      t.remainingSec = (mode==="focus" ? t.focusMins : t.breakMins) * 60;
      t.lastStatusChange = now();
    }

    function tick(){
      const t = state.timer;
      if(!t.running) return;
      if(t.remainingSec > 0){
        t.remainingSec--;
        if(t.mode==="focus" && t.remainingSec % 30 === 0){
          nudgeEnergy(-1);
          nudgeHunger(-0.5);
        }
        renderTimer();
        if(t.remainingSec === 0){
          completeSession();
          beep();
        }
      }
      saveState();
    }

    /** -------------------------------
     * Pet Stats
     * ------------------------------- */
    function nudgeHunger(delta){
      state.pet.hunger = clamp(state.pet.hunger + delta, 0, 100);
      updateBars(); setPetFace(); saveState();
    }
    function nudgeEnergy(delta){
      state.pet.energy = clamp(state.pet.energy + delta, 0, 100);
      updateBars(); setPetFace(); saveState();
    }
    function nudgeMood(delta){
      state.pet.mood = clamp(state.pet.mood + delta, 0, 100);
      updateBars(); setPetFace(); saveState();
    }
    function nudgeClean(delta){
      state.pet.clean = clamp(state.pet.clean + delta, 0, 100);
      updateBars(); setPetFace(); saveState();
    }

    function petShake(){
      els.petSvg.classList.remove('shake');
      void els.petSvg.offsetWidth;
      els.petSvg.classList.add('shake');
    }

    // passive decay on load / hourly-ish
    function passiveUpdate(){
      const last = new Date(state.pet.lastTick);
      const nowd = new Date();
      const mins = Math.max(0, Math.floor((nowd - last)/60000));
      if(mins > 0){
        const halfHours = Math.floor(mins/30);
        if(halfHours > 0){
          nudgeHunger(-1*halfHours);
          nudgeClean(-0.5*halfHours);
          const moodAdj = (state.pet.hunger + state.pet.energy)/40 - 2;
          nudgeMood(moodAdj * halfHours);
        }
        state.pet.lastTick = now();
        saveState();
      }
    }

    /** -------------------------------
     * Tasks
     * ------------------------------- */
    function addTask(text){
      const t = { id: uid(), text: text.trim(), done:false, createdAt: now() };
      state.tasks.unshift(t);
      renderTasks(); saveState();
    }
    function toggleTask(id, done){
      const t = state.tasks.find(x=>x.id===id);
      if(!t) return;
      t.done = done;
      t.doneAt = done ? now() : undefined;
      if(done){
        state.stats.completedToday++;
        nudgeHunger(+4); nudgeMood(+3);
        checkDailyStreak(true);
        maybeEarn("five_in_day", state.stats.completedToday >= 5);
      }else{
        state.stats.completedToday = Math.max(0, state.stats.completedToday - 1);
        nudgeMood(-2);
      }
      renderTasks(); renderAchievements(); saveState();
    }
    function deleteTask(id){
      state.tasks = state.tasks.filter(x=>x.id!==id);
      renderTasks(); saveState();
    }

    /** -------------------------------
     * Streaks & Achievements
     * ------------------------------- */
    function checkDailyStreak(didComplete){
      const today = dateKey(new Date());
      const last = state.stats.lastCompletionDate;

      if(didComplete){
        if(last !== today){
          const yesterday = dateKey(new Date(Date.now() - 86400000));
          state.stats.streakDays = (last === yesterday) ? state.stats.streakDays + 1 : 1;
          state.stats.lastCompletionDate = today;
          maybeEarn("streak_3", state.stats.streakDays >= 3);
          maybeEarn("streak_7", state.stats.streakDays >= 7);
        } // else same-day, streak unchanged
      }
    }

    function maybeEarn(id, cond){
      if(cond && !state.achievements[id]){
        state.achievements[id] = now();
        renderAchievements();
      }
    }

    function awardFocusComplete(){
      const t = state.timer;
      const pausePenalty = clamp(3 - (t.pausesToday||0), 0, 3);
      nudgeHunger(+10 + pausePenalty);
      nudgeEnergy(+8 + Math.max(0, pausePenalty-1));
      nudgeMood(+6 + pausePenalty);
      setTip("Nice focus! Your buddy feasts on your discipline.");
      maybeEarn("first_blood", true);
      state.stats.completedToday++;
      checkDailyStreak(true);
      t.pausesToday = 0;
      // Move to the other mode
      if(t.mode==="focus"){ switchTo("break"); } else { switchTo("focus"); }
      renderTasks(); renderAchievements();
    }

    function dailyRollovers(){
      const today = dateKey(new Date());
      const last = state.stats.lastCompletionDate;
      if(last !== today){
        state.stats.completedToday = 0;
      }
      const p = state.pet;
      maybeEarn("clean_freak", p.clean >= 90);
      maybeEarn("well_fed", p.hunger >= 90);
    }

    /** -------------------------------
     * Beep (best-effort; may be blocked w/o gesture)
     * ------------------------------- */
    function beep(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine"; o.frequency.value = 880;
        o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.3, ctx.currentTime + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.20);
        o.start(); o.stop(ctx.currentTime + 0.21);
      }catch(e){}
    }

    /** -------------------------------
     * Theme
     * ------------------------------- */
    function applyTheme(){
      const t = state.theme;
      if(t==="auto"){ document.documentElement.removeAttribute("data-theme"); return; }
      document.documentElement.setAttribute("data-theme", t);
    }

    /** -------------------------------
     * Events
     * ------------------------------- */
    els.petName.addEventListener('input', (e)=>{
      state.petName = e.target.value || "Buddy";
      saveState();
    });

    $('#feedBtn').addEventListener('click', ()=>{
      nudgeHunger(+12); nudgeMood(+3); petShake(); setTip(`${state.petName} munches happily.`);
    });
    $('#restBtn').addEventListener('click', ()=>{
      nudgeEnergy(+12); nudgeMood(+2); setTip(`${state.petName} took a power nap.`);
    });
    $('#washBtn').addEventListener('click', ()=>{
      nudgeClean(+15); nudgeMood(+1); setTip(`${state.petName} is squeaky clean.`);
    });

    els.startBtn.addEventListener('click', startTimer);
    els.pauseBtn.addEventListener('click', pauseTimer);
    els.resetBtn.addEventListener('click', resetTimer);
    els.completeBtn.addEventListener('click', completeSession);
    els.focusMins.addEventListener('change', ()=>{
      const v = clamp(parseInt(els.focusMins.value||25,10), 5, 180);
      state.timer.focusMins = v;
      if(state.timer.mode==="focus" && !state.timer.running){
        state.timer.remainingSec = v*60;
      }
      renderTimer(); saveState();
    });
    els.breakMins.addEventListener('change', ()=>{
      const v = clamp(parseInt(els.breakMins.value||5,10), 1, 60);
      state.timer.breakMins = v;
      if(state.timer.mode==="break" && !state.timer.running){
        state.timer.remainingSec = v*60;
      }
      renderTimer(); saveState();
    });
    els.autoCycle.addEventListener('click', ()=>{
      state.timer.autoCycle = !state.timer.autoCycle;
      renderTimer(); saveState();
    });

    els.taskForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const txt = els.taskText.value.trim();
      if(!txt) return;
      addTask(txt);
      els.taskText.value = "";
    });

    els.exportBtn.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `tamagotchi-backup-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    });
    els.importBtn.addEventListener('click', ()=> els.importFile.click());
    els.importFile.addEventListener('change', async (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      try{
        const txt = await f.text();
        const obj = JSON.parse(txt);
        state = migrateState(obj);
        saveState();
        renderAll();
        setTip("Backup imported.");
      }catch(err){
        alert("Import failed. Invalid file.");
      }finally{
        els.importFile.value = "";
      }
    });
    els.resetData.addEventListener('click', ()=>{
      if(confirm("This will erase all local data and reset the app. Continue?")){
        localStorage.removeItem(STORE_KEY);
        state = defaultState();
        saveState(); renderAll();
      }
    });

    els.themeBtn.addEventListener('click', ()=>{
      const order = ["auto","light","dark"];
      const i = order.indexOf(state.theme);
      state.theme = order[(i+1)%order.length];
      applyTheme(); saveState();
      els.themeBtn.textContent = state.theme[0].toUpperCase() + state.theme.slice(1);
    });
    els.themeBtn.textContent = state.theme[0].toUpperCase() + state.theme.slice(1);

    /** -------------------------------
     * Boot
     * ------------------------------- */
    function boot(){
      passiveUpdate();
      dailyRollovers();
      renderAll();

      // Resync timer on reload
      try{
        const last = new Date(state.timer.lastStatusChange);
        if(state.timer.running){
          const elapsed = Math.floor((Date.now() - last.getTime())/1000);
          state.timer.remainingSec = Math.max(0, state.timer.remainingSec - elapsed);
          if(state.timer.remainingSec === 0){
            completeSession();
          }else{
            tickHandle = setInterval(tick, 1000);
          }
        }
      }catch(e){}
      saveState();
    }

    boot();
  })();
  </script>
</body>
</html>
